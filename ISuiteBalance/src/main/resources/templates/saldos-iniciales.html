<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Configuración saldos iniciales | Suite Balance ISB</title>

    <link rel="stylesheet" th:href="@{/css/style2.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/fuentes.css}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="icon" href="data:,">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <style>
        .card { background:#fff; border-radius:10px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.06); }
        .row { display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end; }
        .col { display:flex; flex-direction:column; gap:6px; }
        .col-2 { flex:1 1 220px; }
        .col-3 { flex:1 1 320px; }
        .col-1 { flex:0 0 160px; }

        label { font-weight:600; }
        select,input[type="number"],input[type="date"] {
          width:100%; padding:8px 10px; border:1px solid #d7d7d7; border-radius:8px; font-family:inherit;
        }

        .tipo-wrap{ display:flex; gap:10px; flex-wrap:wrap; }
        .tipo-pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:20px; background:#f2f2f2; cursor:pointer; }
        .tipo-pill input{ accent-color:#e63946; }

        .btn { background:#e63946; color:#fff; border:none; padding:8px 16px; border-radius:6px; font-weight:600; cursor:pointer; }
        .btn:hover { background:#c52f3c; }
        .muted{ color:#666; font-size:.92rem; }

        .tabla-wrapper{ margin-top:14px; }
        td.num, th.num { text-align:right; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 class="fuente-semi">Dashboard</h2>
    <ul class="fuente-p1">
        <li sec:authorize="isAuthenticated()">
            <a th:href="@{/dashboard}">
                <img th:src="@{/img/home.png}" class="icono-opcion_aside" alt="">Inicio</a>
        </li>
        <li sec:authorize="hasAnyRole('Administrador','Contador')">
            <a th:href="@{/balanza-comprobacion}">
                <img th:src="@{/img/balanza.png}" class="icono-opcion_aside" alt="">Balanza</a>
        </li>
        <li sec:authorize="hasAnyRole('Administrador','Contador')">
            <a th:href="@{/saldos-iniciales}" class="active">
                <img th:src="@{/img/gestion-de-usuarios.png}" class="icono-opcion_aside" alt="">Saldos iniciales</a>
        </li>
    </ul>
</div>
<div id="backdrop" class="backdrop"></div>

<div class="main">
    <header>
        <button id="menuBtn" class="menu-btn" aria-label="Abrir menú" title="Menú">
            <i class="fi fi-rr-menu-burger" aria-hidden="true"></i>
        </button>
        <div class="brand"><h1 class="fuente-semita">Suite Balance | ISB</h1></div>
        <div class="user-info">
      <span class="nombre-usuario" data-usuario-target>
        <script th:inline="javascript">
          document.write(localStorage.getItem('lastUserName') || '[[${nombreUsuario}]]' || 'Invitado');
        </script>
      </span>
            <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User" class="avatar">
            <button id="logoutBtn" class="logout-btn" title="Cerrar sesión" aria-label="Cerrar sesión">
                <i class="fi fi-sr-power" aria-hidden="true"></i>
            </button>
            <form id="logoutForm" th:action="@{/logout}" method="post" style="display:none">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            </form>
        </div>
    </header>

    <div class="container_principal fondo-1">
        <main class="gestion-usuarios">
            <div class="contenedor-titulo-gestion">
                <h1 class="titulo-gestion fuente-titulos3 txt-rojo">Asignar valores iniciales</h1>
            </div>

            <div th:if="${param.ok}" class="fuente-p1" style="margin:.5rem 0; color:#0a7f27;">Cambios guardados correctamente.</div>

            <!-- ======= FORMULARIO RÁPIDO (filtra por tipo y guarda 1 cuenta) ======= -->
            <div class="card">
                <form th:action="@{/saldos-iniciales/guardar}" method="post" id="formSingle">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <div class="row">
                        <div class="col col-3">
                            <label>Tipo de cuenta</label>
                            <div class="tipo-wrap">
                                <label class="tipo-pill"><input type="radio" name="tipo" value="ACTIVO" checked> Activo</label>
                                <label class="tipo-pill"><input type="radio" name="tipo" value="PASIVO"> Pasivo</label>
                                <label class="tipo-pill"><input type="radio" name="tipo" value="PATRIMONIO"> Patrimonio</label>
                                <label class="tipo-pill"><input type="radio" name="tipo" value="INGRESO"> Ingreso</label>
                                <label class="tipo-pill"><input type="radio" name="tipo" value="GASTO"> Gasto</label>
                            </div>
                        </div>

                        <div class="col col-3">
                            <label for="cmbCuenta">Cuenta</label>
                            <select id="cmbCuenta">
                                <option value="">Seleccione una cuenta</option>
                                <!-- Cargamos TODAS y filtramos por data-tipo en el cliente -->
                                <option
                                        th:each="c : ${cuentas}"
                                        th:value="${c.idCuenta}"
                                        th:text="${c.codigo + ' - ' + c.nombrecuenta}"
                                        th:attr="data-tipo=${c.tipocuenta}">
                                </option>
                            </select>
                            <div class="muted">El listado se filtra por el tipo seleccionado.</div>
                        </div>

                        <div class="col col-2">
                            <label for="monto">Saldo inicial</label>
                            <input id="monto" type="number" step="0.01" placeholder="0.00">
                        </div>

                        <div class="col col-2">
                            <label for="fecha">Fecha del saldo</label>
                            <input id="fecha" type="date">
                        </div>

                        <div class="col col-1">
                            <!-- Como tu controller espera listas, enviamos arrays con un solo elemento -->
                            <button type="button" class="btn" id="btnGuardarUno">Guardar</button>
                        </div>
                    </div>

                    <!-- Inputs que enviamos realmente -->
                    <div id="payload" style="display:none;"></div>
                </form>
            </div>

            <!-- ======= LISTADO (solo lectura rápido) ======= -->
            <div class="tabla-wrapper">
                <table class="tabla-usuarios">
                    <thead class="fuente-btn">
                    <tr>
                        <th>Código</th>
                        <th>Cuenta</th>
                        <th>Tipo</th>
                        <th class="num">Saldo inicial</th>
                        <th>Fecha</th>
                    </tr>
                    </thead>
                    <tbody class="fuente-p1">
                    <tr th:each="c : ${cuentas}">
                        <td th:text="${c.codigo}">101-01</td>
                        <td th:text="${c.nombrecuenta}">Caja</td>
                        <td th:text="${c.tipocuenta}">ACTIVO</td>
                        <td class="num" th:text="${#numbers.formatDecimal(c.saldoInicial,1,'POINT',2,'POINT')}">0.00</td>
                        <td th:text="${c.fechaSaldoInicial}">—</td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(cuentas)}">
                        <td colspan="5" style="text-align:center;">No hay cuentas registradas.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<script>
    // Sidebar responsive (igual que otras vistas)
    (function(){
      const btn = document.getElementById('menuBtn');
      const sidebar = document.querySelector('.sidebar');
      const backdrop = document.getElementById('backdrop');
      if (!btn || !sidebar || !backdrop) return;
      function openMenu(){ sidebar.classList.add('sidebar--open'); backdrop.classList.add('backdrop--show'); document.body.classList.add('no-scroll'); }
      function closeMenu(){ sidebar.classList.remove('sidebar--open'); backdrop.classList.remove('backdrop--show'); document.body.classList.remove('no-scroll'); }
      btn.addEventListener('click', (e)=>{ e.preventDefault(); sidebar.classList.contains('sidebar--open')? closeMenu() : openMenu(); });
      backdrop.addEventListener('click', closeMenu);
      window.addEventListener('resize', ()=>{ if (window.innerWidth > 767) closeMenu(); });
    })();

    // Filtrar opciones del combo por tipo
    (function(){
      const tipoRadios = document.querySelectorAll('input[name="tipo"]');
      const cmb = document.getElementById('cmbCuenta');

      function aplicarFiltro(){
        const tipoSel = document.querySelector('input[name="tipo"]:checked')?.value || '';
        [...cmb.options].forEach(opt=>{
          if (!opt.value) return; // "Seleccione una cuenta"
          const t = opt.getAttribute('data-tipo') || '';
          opt.hidden = (t !== tipoSel);
        });
        // seleccionar la primera visible
        const first = [...cmb.options].find(o => !o.hidden && o.value);
        cmb.value = first ? first.value : '';
      }
      tipoRadios.forEach(r => r.addEventListener('change', aplicarFiltro));
      aplicarFiltro();
    })();

    // Enviar 1 sola cuenta usando los nombres que espera tu controller (listas)
    (function(){
      const btn = document.getElementById('btnGuardarUno');
      const cmb = document.getElementById('cmbCuenta');
      const monto = document.getElementById('monto');
      const fecha = document.getElementById('fecha');
      const payload = document.getElementById('payload');
      const form = document.getElementById('formSingle');

      btn.addEventListener('click', ()=>{
        if (!cmb.value){ alert('Selecciona una cuenta'); return; }
        payload.innerHTML = '';
        // nombres EXACTOS que consume tu @PostMapping("/saldos-iniciales/guardar")
        payload.insertAdjacentHTML('beforeend', `<input type="hidden" name="idCuenta" value="${cmb.value}">`);
        payload.insertAdjacentHTML('beforeend', `<input type="hidden" name="saldoInicial" value="${monto.value || 0}">`);
        if (fecha.value) payload.insertAdjacentHTML('beforeend', `<input type="hidden" name="fechaSaldoInicial" value="${fecha.value}">`);
        form.submit();
      });
    })();
</script>

<!-- Hidratar usuario en header -->
<script type="module" th:src="@{/JS/UsuarioIndexDB.js}"></script>
<script type="module">
    import { hydrateUserDisplay } from '/JS/UsuarioIndexDB.js';
    hydrateUserDisplay();
</script>

</body>
</html>
