<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Estado de Resultado | Suite Balance ISB</title>

    <link rel="stylesheet" th:href="@{/css/style2.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/fuentes.css}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="icon" href="data:,">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <style>
        .card{background:#fff;border-radius:10px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
        .grid {display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:14px; align-items:end;}
        .grid .span-2{grid-column: span 2 / span 2;}
        .btn{background:#e63946;color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer}
        .btn:hover{background:#c52f3c}
        .muted{color:#666;font-size:.92rem}
        table td.num, table th.num {text-align:right}
        .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:14px}
        .kpi .tile{background:#fff;border-radius:10px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}

        /* ===== Centrar Botón Guardar ===== */
        .guardar-centro{
            display:flex;
            justify-content:center;
            align-items:center;
            width:100%;
            margin-top:14px;
        }

        @media (max-width:900px){ .kpi{grid-template-columns:1fr 1fr} }
        @media (max-width:640px){ .kpi{grid-template-columns:1fr} }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 class="fuente-semi">Dashboard</h2>
    <ul class="fuente-p1">
        <li sec:authorize="isAuthenticated()"><a th:href="@{/dashboard}"><img th:src="@{/img/home.png}" class="icono-opcion_aside" alt="">Inicio</a></li>
        <li sec:authorize="hasAnyRole('Administrador','Contador')"><a th:href="@{/saldos-iniciales}"><img th:src="@{/img/calendario.png}" class="icono-opcion_aside" alt="">Saldos Iniciales</a></li>
        <li sec:authorize="hasRole('Administrador')"><a th:href="@{/gestion-usuario}"><img th:src="@{/img/gestion-de-usuarios.png}" class="icono-opcion_aside" alt="">Gestion Usuario</a></li>
        <li sec:authorize="hasAnyRole('Administrador','Contador')"><a th:href="@{/subir-doc}"><img th:src="@{/img/documento.png}" class="icono-opcion_aside" alt="">Partidas</a></li>
        <li sec:authorize="hasAnyRole('Administrador','Contador')"><a th:href="@{/gestion-partida}"><img th:src="@{/img/carga-de-archivos.png}" class="icono-opcion_aside" alt="">Gestion de Partidas</a></li>
        <li sec:authorize="hasAnyRole('Administrador','Contador')"><a th:href="@{/registro-libro-diario}"><img th:src="@{/img/libro-mayor.png}" class="icono-opcion_aside" alt="">Libro Diario</a></li>
        <li sec:authorize="hasAnyRole('Administrador','Contador')"><a th:href="@{/libro-mayor}"><img th:src="@{/img/mayor.png}" class="icono-opcion_aside" alt="">Libro Mayor</a></li>
        <li sec:authorize="hasAnyRole('Administrador','Contador')"><a th:href="@{/balanza-comprobacion}"><img th:src="@{/img/balanza.png}" class="icono-opcion_aside" alt="">Balanza</a></li>
        <li sec:authorize="hasAnyRole('Administrador','Auditor')"><a th:href="@{/generar-reporte}"><img th:src="@{/img/grafico-de-barras.png}" class="icono-opcion_aside" alt="">Reportes</a></li>
        <li sec:authorize="hasAnyRole('Administrador','Auditor')"><a th:href="@{/bitacora}"><img th:src="@{/img/revisar.png}" class="icono-opcion_aside" alt="">Auditoría</a></li>
        <li><a th:href="@{/about}"><img th:src="@{/img/nosotros.png}" class="icono-opcion_aside" alt="">About</a></li>
    </ul>
</div>
<div id="backdrop" class="backdrop"></div>

<div class="main">
    <header>
        <button id="menuBtn" class="menu-btn" aria-label="Abrir menú" title="Menú"><i class="fi fi-rr-menu-burger" aria-hidden="true"></i></button>
        <div class="brand"><h1 class="fuente-semita">Suite Balance | ISB</h1></div>
        <div class="user-info">
      <span class="nombre-usuario" data-usuario-target>
        <script th:inline="javascript">
          document.write(localStorage.getItem('lastUserName') || '[[${nombreUsuario}]]' || 'Invitado');
        </script>
      </span>
            <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User" class="avatar">
            <button id="logoutBtn" class="logout-btn" title="Cerrar sesión" aria-label="Cerrar sesión"><i class="fi fi-sr-power" aria-hidden="true"></i></button>
            <form id="logoutForm" th:action="@{/logout}" method="post" style="display:none">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            </form>
        </div>
    </header>

    <div class="container_principal fondo-1">
        <main class="gestion-usuarios">
            <div class="contenedor-titulo-gestion">
                <h1 class="titulo-gestion fuente-titulos3 txt-rojo">Estado de Resultado</h1>
            </div>

            <!-- KPIs -->
            <div class="kpi">
                <div class="tile"><div class="fuente-btn">Ingresos</div>
                    <div class="fuente-titulos3" th:text="${#numbers.formatDecimal(ingresos,1,'POINT',2,'POINT')}">0.00</div>
                </div>
                <div class="tile"><div class="fuente-btn">Costos</div>
                    <div class="fuente-titulos3" th:text="${#numbers.formatDecimal(costos,1,'POINT',2,'POINT')}">0.00</div>
                </div>
                <div class="tile"><div class="fuente-btn">Gastos</div>
                    <div class="fuente-titulos3" th:text="${#numbers.formatDecimal(gastos,1,'POINT',2,'POINT')}">0.00</div>
                </div>
                <div class="tile"><div class="fuente-btn">Utilidad o Pérdida Neta</div>
                    <div class="fuente-titulos3" th:classappend="${utilidad>=0} ? ' txt-verde' : ' txt-rojo'"
                         th:text="${#numbers.formatDecimal(utilidad,1,'POINT',2,'POINT')}">0.00</div>
                </div>
            </div>

            <!-- Tabla resumen -->
            <div class="card" style="margin-top:14px">
                <table class="tabla-usuarios">
                    <thead class="fuente-btn">
                    <tr><th>Concepto</th><th class="num">Monto</th></tr>
                    </thead>
                    <tbody class="fuente-p1">
                    <tr><td>Ingresos del periodo</td>
                        <td class="num" th:text="${#numbers.formatDecimal(ingresos,1,'POINT',2,'POINT')}">0.00</td></tr>
                    <tr><td>Costos del periodo</td>
                        <td class="num" th:text="${#numbers.formatDecimal(costos,1,'POINT',2,'POINT')}">0.00</td></tr>
                    <tr><td>Gastos del periodo</td>
                        <td class="num" th:text="${#numbers.formatDecimal(gastos,1,'POINT',2,'POINT')}">0.00</td></tr>
                    <tr>
                        <td class="fuente-btn">Utilidad Neta</td>
                        <td class="num fuente-btn" th:classappend="${utilidad>=0} ? ' txt-verde' : ' txt-rojo'"
                            th:text="${#numbers.formatDecimal(utilidad,1,'POINT',2,'POINT')}">0.00</td>
                    </tr>
                    </tbody>
                </table>

                <div class="guardar-centro">
                    <form th:action="@{/estado-resultado/guardar}" method="post" style="display:flex; gap:8px;">
                        <input type="hidden" name="desde" th:value="${desde}">
                        <input type="hidden" name="hasta" th:value="${hasta}">
                        <button class="btn fuente-btn" type="submit">Guardar en BD</button>
                    </form>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
    const ok = /*[[${msgOk}]]*/ null, err = /*[[${msgErr}]]*/ null;
    if (ok) Swal.fire({icon:'success', title:'¡Éxito!', text: ok, timer:2200, showConfirmButton:false});
    if (err) Swal.fire({icon:'error', title:'Error', text: err});
</script>

<script type="module" th:src="@{/JS/UsuarioIndexDB.js}"></script>
<script type="module">
    import { hydrateUserDisplay } from '/JS/UsuarioIndexDB.js';
    hydrateUserDisplay();
</script>

</body>
</html>
