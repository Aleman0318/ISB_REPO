<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balanza | Suite Balance ISB</title>

    <link rel="stylesheet" th:href="@{/css/style2.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/fuentes.css}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="icon" href="data:,">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <!-- âœ… Estilos para impresiÃ³n y botÃ³n unificado -->
    <style>
        @media print {
            body {
                background: #fff !important;
                color: #000 !important;
                font-family: 'Inter', sans-serif !important;
                margin: 1.5cm;
            }

            header, .sidebar, .filtros-card__body, .btn, #backdrop {
                display: none !important;
            }

            .main {
                margin: 0 !important;
                padding: 0 !important;
                background: none !important;
            }

            h1.titulo-gestion {
                text-align: center;
                color: #000 !important;
                font-size: 28px;
                margin-bottom: 20px;
            }

            table {
                border-collapse: collapse !important;
                width: 100% !important;
                font-size: 14px;
            }

            th, td {
                border: 1px solid #999 !important;
                padding: 5px 8px !important;
                color: #000 !important; /* ðŸ”§ encabezados y celdas negros */
            }

            th {
                background: #eee !important;
                -webkit-print-color-adjust: exact;
                color: #000 !important;
            }

            tfoot th {
                background: #f2f2f2 !important;
                font-weight: bold;
                -webkit-print-color-adjust: exact;
                color: #000 !important;
            }

            .nota-impresion {
                font-size: 12px;
                margin-top: 2rem !important;
                text-align: left;
                color: #444;
            }
        }

        /* âœ… Botones unificados */
        .btn {
            background: #e63946;
            color: #fff;
            border: none;
            padding: 6px 14px;
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn:hover {
            background: #c52f3c;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 class="fuente-semi">Dashboard</h2>
    <ul class="fuente-p1">
        <li sec:authorize="isAuthenticated()">
            <a th:href="@{/dashboard}">
                <img th:src="@{/img/home.png}" alt="Eliminar" class="icono-opcion_aside">Inicio</a>
        </li>
        <li sec:authorize="hasRole('Administrador')">
            <a th:href="@{/gestion-usuario}">
                <img th:src="@{/img/gestion-de-usuarios.png}" alt="gestionUsu" class="icono-opcion_aside">Gestion Usuario</a>
        </li>
        <li sec:authorize="hasAnyRole('Administrador','Contador')">
            <a th:href="@{/subir-doc}">
                <img th:src="@{/img/documento.png}" alt="Documento" class="icono-opcion_aside">Partidas</a>
        </li>
        <li sec:authorize="hasAnyRole('Administrador','Contador')">
            <a th:href="@{/gestion-partida}">
                <img th:src="@{/img/carga-de-archivos.png}" alt="gestionPartida" class="icono-opcion_aside">Gestion de Partidas</a>
        </li>
        <li sec:authorize="hasAnyRole('Administrador','Contador')">
            <a th:href="@{/registro-libro-diario}">
                <img th:src="@{/img/libro-mayor.png}" alt="Libro" class="icono-opcion_aside">Libro Diario</a>
        </li>
        <li sec:authorize="hasAnyRole('Administrador','Contador')">
            <a th:href="@{/libro-mayor}">
                <img th:src="@{/img/mayor.png}" alt="Libro" class="icono-opcion_aside">Libro Mayor</a>
        </li>
        <li sec:authorize="hasAnyRole('Administrador','Contador')">
            <a th:href="@{/balanza-comprobacion}" class="active">
                <img th:src="@{/img/balanza.png}" alt="Libro" class="icono-opcion_aside">Balanza</a>
        </li>
        <li sec:authorize="hasAnyRole('Administrador','Auditor')">
            <a th:href="@{/generar-reporte}">
                <img th:src="@{/img/grafico-de-barras.png}" alt="Reporte" class="icono-opcion_aside">Reportes</a>
        </li>
        <li sec:authorize="hasAnyRole('Administrador','Auditor')">
            <a th:href="@{/bitacora}">
                <img th:src="@{/img/revisar.png}" alt="Auditoria" class="icono-opcion_aside">AuditorÃ­a</a>
        </li>
        <li>
            <a th:href="@{/about}">
                <img th:src="@{/img/nosotros.png}" alt="Libro" class="icono-opcion_aside">About</a>
        </li>
    </ul>
</div>
<div id="backdrop" class="backdrop"></div>

<div class="main">
    <header>
        <button id="menuBtn" class="menu-btn" aria-label="Abrir menÃº" title="MenÃº">
            <i class="fi fi-rr-menu-burger" aria-hidden="true"></i>
        </button>
        <div class="brand"><h1>Suite Balance | ISB</h1></div>
        <div class="user-info">
            <span class="nombre-usuario" data-usuario-target>
                <script th:inline="javascript">
                  document.write(localStorage.getItem('lastUserName') || '[[${nombreUsuario}]]' || 'Invitado');
                </script>
            </span>
            <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User" class="avatar">
            <button id="logoutBtn" class="logout-btn" title="Cerrar sesiÃ³n" aria-label="Cerrar sesiÃ³n">
                <i class="fi fi-sr-power" aria-hidden="true"></i>
            </button>
            <form id="logoutForm" th:action="@{/logout}" method="post" style="display:none">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            </form>
        </div>
    </header>

    <div class="container_principal fondo-1">
        <main class="gestion-usuarios">
            <div class="contenedor-titulo-gestion">
                <h1 class="titulo-gestion fuente-titulos3 txt-rojo">Balanza de ComprobaciÃ³n</h1>
            </div>

            <!-- ====== FORM DE FILTROS Y BOTONES ====== -->
            <form th:action="@{/balanza-comprobacion}" method="get" id="formFiltros" style="display:inline-block;">
                <div class="filtros-card__body">
                    <div class="buscador-wrap filtros-row">
                        <div class="filtro-col">
                            <span class="filtro-label fuente-p1">Rango de fechas</span>
                            <div class="rango">
                                <label for="fDesde">Desde</label>
                                <input id="fDesde" name="desde" type="date" class="input" th:value="${desde}">
                                <span>â€“</span>
                                <label for="fHasta">Hasta</label>
                                <input id="fHasta" name="hasta" type="date" class="input" th:value="${hasta}">
                            </div>
                        </div>

                        <div class="filtro-col botones">
                            <button type="submit" class="btn fuente-btn">Buscar</button>
                            <button id="limpiarBusqueda" class="btn fuente-btn" type="button">Limpiar</button>
                            <button type="button" class="btn fuente-btn" onclick="window.print()">Imprimir / Exportar</button>
                            <!-- âœ… Guardar junto a Imprimir -->
                            <form th:action="@{/balanza-comprobacion/guardar}" method="post" id="formGuardar" style="display:inline;">
                                <input type="hidden" name="desde" th:value="${desde}">
                                <input type="hidden" name="hasta" th:value="${hasta}">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <button type="submit" class="btn fuente-btn">Guardar en BD</button>
                            </form>
                        </div>
                    </div>
                </div>
            </form>

            <div style="margin:.5rem 0;">
                <small th:if="${validacionOk}" class="badge-ok">âœ” DÃ©bitos = CrÃ©ditos</small>
                <small th:if="${!validacionOk}" class="badge-err">âœ– Descuadre: revise los datos</small>
            </div>

            <!-- ====== TABLA ====== -->
            <div id="balanzaResultados">
                <div class="tabla-wrapper">
                    <table class="tabla-usuarios">
                        <thead class="fuente-btn">
                        <tr>
                            <th>CÃ³digo</th>
                            <th>Cuenta</th>
                            <th>Saldo Inicial</th>
                            <th>DÃ©bitos</th>
                            <th>CrÃ©ditos</th>
                            <th>Saldo Final Deudor</th>
                            <th>Saldo Final Acreedor</th>
                        </tr>
                        </thead>
                        <tbody class="fuente-p1">
                        <tr th:if="${#lists.isEmpty(filas)}">
                            <td colspan="7" style="text-align:center;" class="fuente-p1">No hay datos para el rango seleccionado.</td>
                        </tr>
                        <tr th:each="r : ${filas}">
                            <td th:text="${r.codigo}">101-01</td>
                            <td th:text="${r.nombre}">Caja</td>
                            <td th:text="${#numbers.formatDecimal(r.saldoInicial,1,'POINT',2,'POINT')}">0.00</td>
                            <td th:text="${#numbers.formatDecimal(r.debitos,1,'POINT',2,'POINT')}">0.00</td>
                            <td th:text="${#numbers.formatDecimal(r.creditos,1,'POINT',2,'POINT')}">0.00</td>
                            <td th:text="${r.saldoFinal.signum()>=0 ? #numbers.formatDecimal(r.saldoFinal,1,'POINT',2,'POINT') : '0.00'}">0.00</td>
                            <td th:text="${r.saldoFinal.signum()<0 ? #numbers.formatDecimal(r.saldoFinal.negate(),1,'POINT',2,'POINT') : '0.00'}">0.00</td>
                        </tr>
                        </tbody>
                        <tfoot>
                        <tr class="fuente-p1">
                            <th colspan="2" style="text-align:right;">Totales</th>
                            <th th:text="${#numbers.formatDecimal(totalSaldoInicial,1,'POINT',2,'POINT')}">0.00</th>
                            <th th:text="${#numbers.formatDecimal(totalDebitos,1,'POINT',2,'POINT')}">0.00</th>
                            <th th:text="${#numbers.formatDecimal(totalCreditos,1,'POINT',2,'POINT')}">0.00</th>
                            <th th:text="${#numbers.formatDecimal(totalFinalDeudor,1,'POINT',2,'POINT')}">0.00</th>
                            <th th:text="${#numbers.formatDecimal(totalFinalAcreedor,1,'POINT',2,'POINT')}">0.00</th>
                        </tr>
                        </tfoot>
                    </table>
                </div>

                <small class="nota-impresion fuente-p2">
                    Nota: Saldo Final = Saldo Inicial + DÃ©bitos âˆ’ CrÃ©ditos. Si resulta &gt; 0 se muestra como Deudor; si &lt; 0, como Acreedor.
                </small>
            </div>
        </main>
    </div>
</div>

<!-- âœ… SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
    const msgOk = /*[[${msgOk}]]*/ null;
    if (msgOk) {
      Swal.fire({
        title: 'Â¡Ã‰xito!',
        text: msgOk,
        icon: 'success',
        timer: 2500,
        showConfirmButton: false,
        timerProgressBar: true,
        toast: true,
        position: 'top-end'
      });
    }
</script>

</body>
</html>
